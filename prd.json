{
  "title": "Provider Architecture Optimization for Bundle Size Reduction",
  "version": "1.0.0",
  "status": "draft",
  "summary": {
    "problem": "VeChain Kit's bundle size is ~1.7MB because the VeChainKitProvider loads all features unconditionally, preventing tree-shaking from working.",
    "rootCause": [
      "Privy (~500KB) - even when not configured",
      "DAppKit (~200KB) - even when not configured",
      "Wagmi (~150KB) - always loaded",
      "All modal components (~500KB) - even when never opened",
      "ReactQueryDevtools (~100KB) - even in production",
      "Chakra UI (~300KB) - always loaded"
    ],
    "solution": "Make the provider modular with conditional loading and lazy-loaded components.",
    "expectedImpact": "60-80% bundle size reduction for typical applications (1.7MB -> 300-600KB)"
  },
  "goals": [
    "Reduce minimum bundle size from 1.7MB to ~60KB for core functionality",
    "Make heavy dependencies optional - Only load if configured",
    "Lazy-load UI components - Modals only when needed",
    "Remove dev tools from production - ReactQueryDevtools should be dev-only",
    "Enable selective provider usage - Consumers choose what they need",
    "Maintain backward compatibility - Existing code still works"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Remove ReactQueryDevtools from production builds",
      "priority": "P0",
      "description": "ReactQueryDevtools should only be included in development, not production.",
      "acceptanceCriteria": [
        "Wrap ReactQueryDevtools in process.env.NODE_ENV === 'development' check",
        "Verify devtools don't appear in production bundle",
        "Bundle size reduced by ~100KB",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-100KB (-6%)",
      "status": "completed",
      "passes": true,
      "notes": "Implemented lazy loading of ReactQueryDevtools with process.env.NODE_ENV check. In production, the component returns null and the devtools chunk is not imported. Used React.lazy() for dynamic import to enable tree-shaking. Typecheck passes."
    },
    {
      "id": "US-002",
      "title": "Make PrivyProvider conditional",
      "priority": "P0",
      "description": "Only load PrivyProvider when privy prop is provided.",
      "acceptanceCriteria": [
        "PrivyProvider only renders when privy prop exists",
        "Apps without Privy don't bundle @privy-io/react-auth",
        "All Privy-dependent hooks handle missing provider gracefully",
        "Tests verify both with/without Privy scenarios",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-500KB (-29%) for apps not using Privy",
      "status": "completed",
      "passes": true,
      "notes": "Implemented conditional PrivyProvider loading using React.lazy() for dynamic imports. When privy prop is not provided: (1) PrivyProvider is not rendered - uses LazyPrivyProvider with Suspense only when isPrivyConfigured is true, (2) PrivyWalletProvider is also conditionally rendered, (3) Created useOptionalPrivyWalletProvider hook that returns null when provider is missing, (4) Created useOptionalPrivy hook for graceful Privy context handling, (5) Updated useWallet, useSignTypedData, useSignMessage, and useSendTransaction to use optional hooks and handle missing providers with helpful error messages. Removed dummy Privy credentials that were previously loaded when Privy was not configured. Typecheck passes."
    },
    {
      "id": "US-003",
      "title": "Make DAppKitProvider conditional",
      "priority": "P0",
      "description": "Only load DAppKitProvider when dappKit prop is provided.",
      "acceptanceCriteria": [
        "DAppKitProvider only renders when dappKit prop exists",
        "Apps without DAppKit don't bundle @vechain/dapp-kit-react",
        "All DAppKit-dependent hooks handle missing provider gracefully",
        "Wallet connections still work via Privy when DAppKit is disabled",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-200KB (-12%) for apps not using direct wallet connections",
      "status": "completed",
      "passes": true,
      "notes": "Implemented conditional DAppKitProvider loading using React.lazy() for dynamic imports. When dappKit prop is not provided: (1) DAppKitProvider is not rendered - uses LazyDAppKitProvider with Suspense only when isDAppKitConfigured is true, (2) ThorProvider is used as fallback to provide Thor client access for blockchain operations, (3) Created useOptionalThor hook that returns Thor client from DAppKit if available or falls back to ThorProvider, (4) Created useOptionalDAppKitWallet hook with graceful handling for missing provider and mock signer, (5) Created useOptionalDAppKitWalletModal hook for wallet modal operations, (6) Updated 20+ hooks to use optional variants: useWallet, useSignMessage, useSignTypedData, useSendTransaction, useCallClause, useEvents, useCurrentBlock, useGetChainId, useAccountBalance, useTxReceipt, useSmartAccount, and all other Thor-dependent hooks, (7) Made VeChainKitConfig.dappKit optional, (8) Removed automatic default dappKit config to allow opt-out. Typecheck passes."
    },
    {
      "id": "US-004",
      "title": "Make PrivyCrossAppProvider conditional",
      "priority": "P1",
      "description": "Only load wagmi/PrivyCrossAppProvider when ecosystem login is enabled.",
      "acceptanceCriteria": [
        "Check if ecosystem login is in loginMethods array",
        "Only render PrivyCrossAppProvider if ecosystem login enabled",
        "Apps without ecosystem login don't bundle wagmi",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-150KB (-9%) for apps not using ecosystem login",
      "status": "pending"
    },
    {
      "id": "US-005",
      "title": "Lazy-load modal components",
      "priority": "P0",
      "description": "Modal components should only load when actually opened, not eagerly at provider initialization.",
      "acceptanceCriteria": [
        "Convert modal imports to React.lazy()",
        "Wrap in Suspense with appropriate fallback",
        "Modals only in bundle when code-split chunk is loaded",
        "Modal open/close functionality works identically",
        "No flash of unstyled content on first open",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-500KB (-29%) - modals only load when opened",
      "status": "pending"
    },
    {
      "id": "US-006",
      "title": "Make Chakra UI optional with headless mode",
      "priority": "P1",
      "description": "Apps that don't use VeChain Kit's UI components shouldn't need to bundle Chakra UI.",
      "acceptanceCriteria": [
        "Add headless prop to VeChainKitProvider",
        "When headless=true, don't load ChakraProvider",
        "When headless=true, modals/UI components don't render",
        "Hooks still work in headless mode",
        "Document headless mode in README",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-300KB (-18%) for apps building custom UI",
      "status": "pending"
    },
    {
      "id": "US-007",
      "title": "Create VeChainKitCoreProvider (minimal provider)",
      "priority": "P2",
      "description": "Provide a minimal provider for apps that want maximum control.",
      "acceptanceCriteria": [
        "Create new VeChainKitCoreProvider component",
        "Only includes context + React Query",
        "No Privy, DAppKit, Wagmi, Chakra",
        "Hooks that depend on missing providers show helpful error messages",
        "Document when to use Core vs Full provider",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "-1.6MB (-95%) for advanced users building custom solutions",
      "status": "pending"
    },
    {
      "id": "US-008",
      "title": "Fix circular dependencies",
      "priority": "P1",
      "description": "Break the circular dependency chain between providers, hooks, and components.",
      "acceptanceCriteria": [
        "Identify all circular import chains",
        "Create dependency graph visualization",
        "Move shared utilities to break cycles",
        "Verify no circular dependencies with madge or circular-dependency-plugin",
        "Typecheck passes (yarn kit:typecheck)"
      ],
      "impact": "Enables proper tree-shaking (foundation for other optimizations)",
      "status": "pending"
    },
    {
      "id": "US-009",
      "title": "Add bundle size regression testing",
      "priority": "P1",
      "description": "Automated testing to catch bundle size increases.",
      "acceptanceCriteria": [
        "Add size-limit or bundlesize package",
        "Configure max bundle size thresholds for each entry point",
        "CI fails if bundle size increases beyond threshold",
        "Document expected sizes in package.json",
        "Add yarn size command to check locally"
      ],
      "impact": "Prevent future bundle size bloat",
      "status": "pending"
    },
    {
      "id": "US-010",
      "title": "Update examples to demonstrate optimizations",
      "priority": "P1",
      "description": "Update example apps to demonstrate different optimization strategies and measure actual bundle impact.",
      "acceptanceCriteria": [
        "next-template: Use subpath imports, conditional providers, measure ~400KB bundle",
        "homepage: Keep full-featured setup, document ~1.0MB bundle",
        "playground: Keep unchanged for backward compatibility testing",
        "Document bundle sizes in each example's README",
        "Add optimization guide to main README",
        "All examples build successfully"
      ],
      "impact": "Demonstrates real-world bundle size wins, helps consumers optimize their apps",
      "status": "pending"
    }
  ],
  "phases": [
    {
      "id": 1,
      "name": "Quick Wins",
      "priority": "P0",
      "description": "Immediate impact optimizations",
      "userStories": ["US-001", "US-002", "US-005"],
      "expectedImpact": "-600KB to -1.1MB depending on configuration"
    },
    {
      "id": 2,
      "name": "Conditional Loading",
      "priority": "P0-P1",
      "description": "Make providers conditional based on configuration",
      "userStories": ["US-003", "US-004", "US-006"],
      "expectedImpact": "Additional -300KB to -650KB depending on features used"
    },
    {
      "id": 3,
      "name": "Architecture",
      "priority": "P1-P2",
      "description": "Fix underlying architecture issues",
      "userStories": ["US-008", "US-007", "US-009"],
      "expectedImpact": "Foundation for future optimizations + protection against regression"
    },
    {
      "id": 4,
      "name": "Examples & Protection",
      "priority": "P1",
      "description": "Update examples and add CI protection",
      "userStories": ["US-010", "US-009"],
      "expectedImpact": "Documentation and regression prevention"
    }
  ],
  "successMetrics": {
    "bundleSizeTargets": [
      {
        "useCase": "All features",
        "current": "1.7MB",
        "target": "1.0MB",
        "reduction": "-40%"
      },
      {
        "useCase": "Privy + Modals",
        "current": "1.7MB",
        "target": "600KB",
        "reduction": "-65%"
      },
      {
        "useCase": "DAppKit only",
        "current": "1.7MB",
        "target": "400KB",
        "reduction": "-76%"
      },
      {
        "useCase": "Hooks only (headless)",
        "current": "1.7MB",
        "target": "200KB",
        "reduction": "-88%"
      },
      {
        "useCase": "Core provider only",
        "current": "1.7MB",
        "target": "60KB",
        "reduction": "-96%"
      }
    ],
    "technicalMetrics": [
      "Production bundles don't include ReactQueryDevtools",
      "Apps without Privy don't bundle @privy-io/react-auth",
      "Modals are code-split (separate chunks)",
      "Zero circular dependencies detected by madge",
      "All typecheck passes",
      "All example apps build successfully",
      "Backward compatibility maintained (existing code works)"
    ]
  },
  "exampleBundleTargets": [
    {
      "example": "next-template",
      "current": "1.71MB",
      "target": "~400KB",
      "configuration": "Optimized (DAppKit only, subpath imports)"
    },
    {
      "example": "homepage",
      "current": "1.72MB",
      "target": "~1.0MB",
      "configuration": "Full-featured (all providers, showcase)"
    },
    {
      "example": "playground",
      "current": "1.72MB",
      "target": "~1.0MB",
      "configuration": "Full-featured (backward compat test)"
    },
    {
      "example": "minimal-template",
      "current": "N/A",
      "target": "~200KB",
      "configuration": "Headless (hooks only, core provider)"
    }
  ],
  "risks": [
    {
      "risk": "Breaking Changes",
      "description": "Making providers conditional could break existing apps",
      "mitigation": "Maintain backward compatibility by default, gradual migration path, clear documentation, version as minor release with migration guide"
    },
    {
      "risk": "Runtime Errors",
      "description": "Hooks fail when provider is missing",
      "mitigation": "Add helpful error messages, error boundaries with clear instructions, TypeScript types guide correct usage"
    },
    {
      "risk": "Complexity",
      "description": "Multiple provider variants increase maintenance burden",
      "mitigation": "Share common logic in utilities, comprehensive test coverage, clear documentation of provider hierarchy"
    },
    {
      "risk": "Bundle Size Regression",
      "description": "Future changes re-introduce bloat",
      "mitigation": "Automated size-limit checks in CI, bundle size tracking in PRs, regular audits"
    }
  ],
  "openQuestions": [
    "Privy/DAppKit mutual exclusivity: Can an app work without both providers? Need to verify wallet connection paths.",
    "Error boundaries: Should we auto-add error boundaries for missing providers, or let apps handle it?",
    "Breaking change version: Should this be 3.0.0 or can we maintain backward compat in 2.x?",
    "Default behavior: Should new apps default to minimal (opt-in features) or full (opt-out features)?",
    "Chakra UI dependency: Can we make Chakra truly optional or does the component architecture require it?"
  ],
  "dependencyWeights": {
    "@privy-io/react-auth": "~500KB",
    "@vechain/dapp-kit-react": "~200KB",
    "wagmi": "~150KB",
    "@chakra-ui/react": "~300KB",
    "modalComponents": "~500KB",
    "ReactQueryDevtools": "~100KB"
  }
}
