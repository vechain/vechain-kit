name: PR Sonar Scan

on:
    push:
        branches:
            - main
    pull_request_target: # zizmor: ignore[dangerous-triggers] # Accepted risk, minimal impact.

jobs:
    sonar-scan:
        name: Sonar Scan
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0
                  ref: ${{ github.event.pull_request.head.sha || github.ref }}

            - name: Cache SonarCloud packages
              uses: actions/cache@v4
              with:
                  path: ~/.sonar/cache
                  key: ${{ runner.os }}-sonar
                  restore-keys: ${{ runner.os }}-sonar

            - name: SonarCloud Scan
              uses: sonarsource/sonarcloud-github-action@ba3875ecf642b2129de2b589510c81a8b53dbf4e # master
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              with:
                  args: >
                      -Dsonar.verbose=false
                      -Dsonar.branch.name=${{ github.head_ref || github.ref_name }}
